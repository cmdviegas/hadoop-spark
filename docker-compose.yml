# ██████╗  ██████╗ █████╗
# ██╔══██╗██╔════╝██╔══██╗
# ██║  ██║██║     ███████║
# ██║  ██║██║     ██╔══██║
# ██████╔╝╚██████╗██║  ██║
# ╚═════╝  ╚═════╝╚═╝  ╚═╝
# DEPARTAMENTO DE ENGENHARIA DE COMPUTACAO E AUTOMACAO
# UNIVERSIDADE FEDERAL DO RIO GRANDE DO NORTE, NATAL/RN
#
# (C) 2022-2025 CARLOS M D VIEGAS
# https://github.com/cmdviegas

name: ${STACK_NAME}

services:
  init:
    image: ubuntu:24.04
    profiles: [init]
    working_dir: /workspace
    volumes:
      - ./:/workspace
    environment:
      - NUM_WORKER_NODES=${NUM_WORKER_NODES}
    command: ["bash", "gen-workers.sh"]
    networks:
      - spark_network

  master:
    image: ${IMAGE_NAME}
    container_name: ${STACK_NAME}-master
    hostname: ${STACK_NAME}-master
    tty: true
    restart: on-failure
    build:
      context: .
      dockerfile: Dockerfile
      args:
        MY_USERNAME: ${MY_USERNAME}
        MY_PASSWORD: ${MY_PASSWORD}
        SPARK_VERSION: ${SPARK_VERSION}
        HADOOP_VERSION: ${HADOOP_VERSION}
        APT_MIRROR: ${APT_MIRROR}
    networks:
      - spark_network
    ports:
      - "9870:9870/tcp"
      - "8088:8088/tcp"
      - "19888:19888/tcp"
      - "18080:18080/tcp"
      - "15002:15002/tcp"
      - "8888:8888/tcp"
    volumes:
      - master:/home/${MY_USERNAME}/
      - ./myfiles:/home/${MY_USERNAME}/myfiles
      - .env:/home/${MY_USERNAME}/.env
    entrypoint: ["bash", "bootstrap.sh"]
    command: ["MASTER"]

networks:
  spark_network:
    name: spark_network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.31.0.0/24

volumes:
  master:
    name: ${STACK_NAME}_master_volume
    driver: local
